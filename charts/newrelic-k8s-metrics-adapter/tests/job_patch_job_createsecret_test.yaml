suite: test naming helper for job-createSecret
templates:
  - templates/apiservice/job-patch/job-createSecret.yaml
release:
  name: my-release
  namespace: my-namespace
tests:
  - it: spec metadata name is is correctly defined
    asserts:
      - equal:
          path: spec.template.metadata.name
          value: nri-my-release-newrelic-k8s-metrics-adapter-apiservice-create
  - it: container args are correctly defined
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].args[1]
          pattern: --host=.*,.*\.my-namespace.svc
      - matchRegex:
          path: spec.template.spec.containers[0].args[3]
          pattern: --secret-name=.*-apiservice
  - it: has the correct image
    set:
      personalAPIKey: 21321
      apiServicePatchJob:
        image:
          repository: k8s.gcr.io/ingress-nginx/kube-webhook-certgen
          tag: "latest"
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^.*k8s.gcr.io/ingress-nginx/kube-webhook-certgen:latest
  - it: renders when extraEnv, extraEnvFrom, extraVolumes and extraVolumeMounts are set
    set:
      personalAPIKey: 21321
      tolerations:
        - key: "key1"
          operator: "Exists"
          effect: "NoSchedule"
      apiServicePatchJob:
        extraEnv:
          - name: ENV_VAR1
            value: "var1"
          - name: ENV_VAR2
            value: "var2"
        extraEnvFrom:
          - configMapRef:
              name: special-config
        extraVolumes:
          - name: tmpfs-data
            emptyDir: {}
        extraVolumeMounts:
          - mountPath: /var/db/newrelic-infra/data
            name: tmpfs-data
    asserts:
      - hasDocuments:
          count: 1
